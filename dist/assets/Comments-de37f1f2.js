import{_ as R,s as y}from"./_plugin-vue_export-helper-b60847f6.js";import{r as g,h as x,g as U,b as c,i as q,o as z,c as P,d as f,e as a,w as l,E as _,f as v,j as K,k as O,t as w,l as B}from"./index-108f509c.js";const A={class:"comments-management"},F={class:"search-actions"},G={class:"action-buttons"},H={class:"pagination"},J={__name:"Comments",setup(Q){const b=g(!1),h=g(""),C=g(1),k=g(10),d=g([]),S=x(()=>d.value.length),D=x(()=>{let t=d.value;if(h.value){const e=h.value.toLowerCase();t=t.filter(n=>n.content.toLowerCase().includes(e)||n.author.toLowerCase().includes(e)||n.post_title.toLowerCase().includes(e))}return t}),$=t=>new Date(t).toLocaleString("zh-CN"),N=async()=>{try{b.value=!0;const t=["comments","comment"];let e=[],n=!1;for(const s of t)try{const{data:i,error:r}=await y.from(s).select(`
            *,
            profiles:author_id (username, email),
            posts:post_id (title)
          `).order("created_at",{ascending:!1});if(!r&&i){e=i,n=!0,console.log(`✅ 从表 ${s} 成功加载评论数据（关联查询）`);break}}catch{try{const{data:r,error:u}=await y.from(s).select("*").order("created_at",{ascending:!1});if(!u&&r){e=r,n=!0,console.log(`✅ 从表 ${s} 成功加载评论数据（简单查询）`);break}}catch(r){console.log(`❌ 表 ${s} 查询失败:`,r)}}if(!n){_.warning("未找到评论数据表，请检查数据库表结构"),d.value=[];return}d.value=e.map(s=>{var i,r,u,m;return{id:s.id,content:s.content||"无内容",author:s.author||((i=s.profiles)==null?void 0:i.username)||((u=(r=s.profiles)==null?void 0:r.email)==null?void 0:u.split("@")[0])||"匿名用户",post_title:s.post_title||((m=s.posts)==null?void 0:m.title)||"未知文章",created_at:s.created_at||new Date().toISOString(),status:s.status||"pending"}}),_.success(`成功加载 ${d.value.length} 条评论`)}catch(t){console.error("加载评论数据失败:",t),_.error("加载评论数据失败，请检查数据库连接")}finally{b.value=!1}},T=async t=>{try{await B.confirm(`确定要${t.status==="approved"?"拒绝":"通过"}评论吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const{error:e}=await y.from("comments").update({status:t.status==="approved"?"rejected":"approved"}).eq("id",t.id);if(e){_.error("更新评论状态失败: "+e.message);return}t.status=t.status==="approved"?"rejected":"approved",_.success("操作成功")}catch{}},V=async t=>{try{await B.confirm("确定要删除这条评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const{error:e}=await y.from("comments").delete().eq("id",t.id);if(e){_.error("删除评论失败: "+e.message);return}d.value=d.value.filter(n=>n.id!==t.id),_.success("删除成功")}catch{}};return U(()=>{N()}),(t,e)=>{const n=c("Search"),s=c("el-icon"),i=c("el-input"),r=c("Refresh"),u=c("el-button"),m=c("el-card"),p=c("el-table-column"),E=c("el-tag"),L=c("el-table"),j=c("el-pagination"),I=q("loading");return z(),P("div",A,[e[5]||(e[5]=f("div",{class:"page-header"},[f("h2",null,"评论管理"),f("p",null,"管理系统评论内容")],-1)),a(m,{class:"search-bar"},{default:l(()=>[f("div",F,[a(i,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=o=>h.value=o),placeholder:"搜索评论内容",style:{width:"300px"},clearable:""},{prefix:l(()=>[a(s,null,{default:l(()=>[a(n)]),_:1})]),_:1},8,["modelValue"]),f("div",G,[a(u,{type:"primary",onClick:t.handleRefresh},{default:l(()=>[a(s,null,{default:l(()=>[a(r)]),_:1}),e[3]||(e[3]=v(" 刷新 ",-1))]),_:1},8,["onClick"])])])]),_:1}),a(m,null,{default:l(()=>[K((z(),O(L,{data:D.value,style:{width:"100%"}},{default:l(()=>[a(p,{prop:"id",label:"ID",width:"80"}),a(p,{prop:"content",label:"评论内容"}),a(p,{prop:"author",label:"评论用户",width:"120"}),a(p,{prop:"post_title",label:"所属文章"}),a(p,{prop:"created_at",label:"评论时间",width:"180"},{default:l(({row:o})=>[v(w($(o.created_at)),1)]),_:1}),a(p,{prop:"status",label:"状态",width:"100"},{default:l(({row:o})=>[a(E,{type:o.status==="approved"?"success":"warning"},{default:l(()=>[v(w(o.status==="approved"?"已审核":"待审核"),1)]),_:2},1032,["type"])]),_:1}),a(p,{label:"操作",width:"200"},{default:l(({row:o})=>[a(u,{size:"small",type:o.status==="approved"?"warning":"success",onClick:M=>T(o)},{default:l(()=>[v(w(o.status==="approved"?"取消审核":"通过审核"),1)]),_:2},1032,["type","onClick"]),a(u,{size:"small",type:"danger",onClick:M=>V(o)},{default:l(()=>[...e[4]||(e[4]=[v(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[I,b.value]]),f("div",H,[a(j,{"current-page":C.value,"onUpdate:currentPage":e[1]||(e[1]=o=>C.value=o),"page-size":k.value,"onUpdate:pageSize":e[2]||(e[2]=o=>k.value=o),"page-sizes":[10,20,50,100],total:S.value,layout:"total, sizes, prev, pager, next, jumper"},null,8,["current-page","page-size","total"])])]),_:1})])}}},Y=R(J,[["__scopeId","data-v-b6acc56e"]]);export{Y as default};
